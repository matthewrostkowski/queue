<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Queue – Live Music</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <!-- Inline tiny transparent favicon to avoid /favicon.ico 404 -->
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgo=" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: #0e0e0f;
      color: #fff;
      padding: 20px;
      padding-bottom: 120px; /* Space for now playing bar */
    }

    .queue-container {
      max-width: 700px;
      margin: 0 auto;
    }

    /* ========== HEADER ========== */
    .queue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-badge {
      background: #1db954;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      color: #000;
    }

    .header-title h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .header-title p {
      font-size: 13px;
      color: #888;
    }

    .play-queue-btn {
      background: #1db954;
      color: #000;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .play-queue-btn:hover {
      background: #1ed760;
      transform: scale(1.05);
    }

    .play-queue-btn:disabled {
      background: #444;
      cursor: not-allowed;
      transform: none;
    }

    /* ========== QUEUE INFO ========== */
    .queue-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 12px 16px;
      background: #1a1a1a;
      border-radius: 10px;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: #1db954;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .song-count {
      font-size: 13px;
      color: #888;
    }

    /* ========== UP NEXT SECTION ========== */
    .up-next-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    /* ========== SONG CARDS ========== */
    .queue-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .song-card {
      display: flex;
      align-items: center;
      background: #0f0f0f;
      border: 1px solid #222;
      border-radius: 16px;
      padding: 12px 16px;
      transition: all 0.3s ease;
      position: relative;
    }

    .song-card.now-playing {
      border-color: #1db954;
      box-shadow: 0 0 20px rgba(29, 185, 84, 0.3);
    }

    .song-card.moving-up {
      animation: moveUp 0.5s ease;
      box-shadow: 0 0 20px rgba(29, 185, 84, 0.5);
      border-color: #1db954;
    }

    @keyframes moveUp {
      0% {
        transform: translateY(0);
        box-shadow: 0 0 0 rgba(29, 185, 84, 0);
      }
      50% {
        transform: translateY(-5px);
        box-shadow: 0 0 30px rgba(29, 185, 84, 0.8);
      }
      100% {
        transform: translateY(0);
        box-shadow: 0 0 20px rgba(29, 185, 84, 0.5);
      }
    }

    .song-card:hover {
      background: #1a1a1a;
      border-color: #333;
    }

    /* Cover art */
    .song-cover {
      width: 64px;
      height: 64px;
      border-radius: 10px;
      overflow: hidden;
      background: #222;
      flex-shrink: 0;
      position: relative;
    }

    .song-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .song-cover .playing-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      display: none;
    }

    .song-card.now-playing .playing-indicator {
      display: block;
      animation: pulse 1s infinite;
    }

    /* Song info */
    .song-info {
      flex: 1;
      min-width: 0;
      padding: 0 16px;
    }

    .song-title {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .song-artist {
      font-size: 13px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .song-meta {
      font-size: 11px;
      color: #666;
    }

    /* Voting section */
    .song-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .vote-btn {
      width: 32px;
      height: 32px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #888;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .vote-btn:hover {
      background: #1db954;
      border-color: #1db954;
      color: #000;
      transform: scale(1.1);
    }

    .vote-score {
      font-size: 14px;
      font-weight: 600;
      color: #1db954;
      min-width: 30px;
      text-align: center;
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-emoji {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }

    .empty-subtitle {
      font-size: 14px;
      margin-bottom: 24px;
    }

    .search-btn {
      display: inline-block;
      padding: 12px 24px;
      background: #1db954;
      color: #000;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .search-btn:hover {
      background: #1ed760;
      transform: scale(1.05);
    }

    /* ========== NOW PLAYING BAR ========== */
    .now-playing-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, #1a1a1a 0%, #0e0e0f 100%);
      border-top: 1px solid #282828;
      padding: 16px 24px;
      display: none;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      z-index: 100;
    }

    .np-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 200px;
    }

    .np-cover {
      width: 56px;
      height: 56px;
      border-radius: 6px;
      overflow: hidden;
      background: #222;
      flex-shrink: 0;
    }

    .np-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .np-info {
      flex: 1;
      min-width: 0;
    }

    .np-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .np-artist {
      font-size: 12px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .np-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      justify-content: center;
      flex-shrink: 0;
    }

    .control-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    .control-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .play-btn {
      width: 48px;
      height: 48px;
      background: #1db954;
      color: #000;
      font-size: 20px;
    }

    .play-btn:hover {
      background: #1ed760;
    }

    .np-progress {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 200px;
      max-width: 400px;
    }

    .np-progress span {
      font-size: 11px;
      color: #888;
      min-width: 40px;
    }

    .progress-bar {
      flex: 1;
      height: 4px;
      background: #404040;
      border-radius: 2px;
      overflow: hidden;
      cursor: pointer;
    }

    .progress-fill {
      height: 100%;
      background: #1db954;
      width: 0%;
      transition: width 0.1s linear;
    }
  </style>
</head>
<body>
  <div class="queue-container">
    <!-- Header -->
    <div class="queue-header">
      <div class="header-left">
        <div class="app-badge">Queue</div>
        <div class="header-title">
          <h1>Live Queue</h1>
          <p>Community-powered playlist</p>
        </div>
      </div>
      <button class="play-queue-btn" id="playQueueBtn">
        ▶ Play Queue
      </button>
    </div>

    <!-- Queue Info -->
    <div class="queue-info">
      <div class="live-indicator">
        <div class="live-dot"></div>
        <span>Live Session</span>
      </div>
      <div class="song-count"><%= pluralize(@queue_items.count, 'song') %> in queue</div>
    </div>

    <!-- Up Next Section -->
    <div class="up-next-section">
      <h2 class="section-title">Up Next</h2>

      <% if @queue_items.any? %>
        <div class="queue-list" id="queueList">
          <% @queue_items.each do |item| %>
            <div class="song-card" 
                 data-queue-item-id="<%= item.id %>" 
                 data-vote-score="<%= item.vote_score %>"
                 data-preview-url="<%= item.preview_url || '' %>">
              <div class="song-cover">
                <% if item.cover_url.present? %>
                  <img src="<%= item.cover_url %>" alt="<%= item.title %>">
                <% else %>
                  <div style="width:100%;height:100%;background:#222;"></div>
                <% end %>
                <div class="playing-indicator">🔊</div>
              </div>

              <div class="song-info">
                <div class="song-title"><%= item.title %></div>
                <div class="song-artist"><%= item.artist %></div>
                <div class="song-meta">
                  Added by <%= item.user_display_name || 'Guest' %>
                  <% if item.duration_ms %>
                    • <%= "#{item.duration_ms / 60000}:#{((item.duration_ms % 60000) / 1000).to_s.rjust(2, '0')}" %>
                  <% end %>
                </div>
              </div>

              <div class="song-actions">
                <button class="vote-btn upvote-btn" data-url="/queue_items/<%= item.id %>/upvote">+</button>
                <div class="vote-score"><%= item.vote_score %></div>
                <button class="vote-btn downvote-btn" data-url="/queue_items/<%= item.id %>/downvote">−</button>
              </div>
            </div>
          <% end %>
        </div>

        <div style="text-align:center;margin-top:24px;">
          <a href="/search" class="search-btn">+ Add More Songs</a>
        </div>
      <% else %>
        <div class="empty-state">
          <div class="empty-emoji">🎵</div>
          <div class="empty-title">Queue is empty</div>
          <p class="empty-subtitle">Be the first to add a song!</p>
          <a href="/search" class="search-btn">Search Music</a>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Now Playing Bar -->
  <div class="now-playing-bar" id="nowPlayingBar" style="display:none;">
    <div class="np-left">
      <div class="np-cover" id="npCover">
        <img src="" alt="Now playing">
      </div>
      <div class="np-info">
        <div class="np-title" id="npTitle">Song Title</div>
        <div class="np-artist" id="npArtist">Artist Name</div>
      </div>
    </div>

    <div class="np-controls">
      <button class="control-btn" id="prevBtn">⏮</button>
      <button class="control-btn play-btn" id="playPauseBtn">▶</button>
      <button class="control-btn" id="nextBtn">⏭</button>
    </div>

    <div class="np-progress">
      <span id="currentTime">0:00</span>
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <span id="totalTime">0:00</span>
    </div>

    <!-- Updated: audio tag with explicit source/type and crossorigin -->
    <audio id="audioPlayer" preload="none" controlslist="nodownload" playsinline crossorigin="anonymous">
      <source id="audioSource" src="" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
  </div>

  <script>
    // Small helper: enforce https (some previews come back http)
    function forceHttps(url) {
      try {
        const u = new URL(url);
        if (u.protocol === 'http:') u.protocol = 'https:';
        return u.toString();
      } catch {
        return url || '';
      }
    }

    // ========== QUEUE PLAYER ==========
    class QueuePlayer {
      constructor() {
        this.audio = document.getElementById('audioPlayer');
        this.audioSource = document.getElementById('audioSource');
        this.currentIndex = 0;
        this.playlist = [];
        this.isPlaying = false;
        this.songCards = [];
        
        this.initializePlaylist();
        this.attachEventListeners();
      }

      initializePlaylist() {
        this.songCards = document.querySelectorAll('.song-card');
        this.playlist = Array.from(this.songCards).map(card => ({
          id: card.dataset.queueItemId,
          title: card.querySelector('.song-title').textContent,
          artist: card.querySelector('.song-artist').textContent,
          cover: card.querySelector('.song-cover img')?.src || '',
          previewUrl: forceHttps(card.dataset.previewUrl || ''),
          element: card
        }));

        // Filter out songs without preview URLs and warn user
        const songsWithoutPreview = this.playlist.filter(song => !song.previewUrl);
        if (songsWithoutPreview.length > 0) {
          console.log(`${songsWithoutPreview.length} song(s) don't have preview URLs`);
        }
      }

      attachEventListeners() {
        document.getElementById('playQueueBtn').addEventListener('click', () => this.playQueue());
        document.getElementById('playPauseBtn').addEventListener('click', () => this.togglePlayPause());
        document.getElementById('nextBtn').addEventListener('click', () => this.playNext());
        document.getElementById('prevBtn').addEventListener('click', () => this.playPrevious());
        
        this.audio.addEventListener('ended', () => this.playNext());
        this.audio.addEventListener('timeupdate', () => this.updateProgress());
        this.audio.addEventListener('error', (e) => this.handleAudioError(e));
      }

      playQueue() {
        if (this.playlist.length === 0) {
          alert('Queue is empty! Add some songs first.');
          return;
        }
        if (!this.audio.canPlayType || !this.audio.canPlayType('audio/mpeg')) {
          alert('This browser cannot play MP3 previews.');
          return;
        }
        this.playSong(0);
      }

      async playSong(index) {
        if (index < 0 || index >= this.playlist.length) {
          // Queue finished
          this.isPlaying = false;
          document.getElementById('playPauseBtn').textContent = '▶';
          this.clearNowPlaying();
          return;
        }
        
        this.currentIndex = index;
        const song = this.playlist[index];
        
        // Update now playing UI
        this.clearNowPlaying();
        song.element.classList.add('now-playing');
        
        // Update now playing bar
        document.getElementById('npTitle').textContent = song.title;
        document.getElementById('npArtist').textContent = song.artist;
        const coverImg = document.getElementById('npCover').querySelector('img');
        coverImg.src = song.cover || '';
        document.getElementById('nowPlayingBar').style.display = 'flex';
        
        // Update button states
        document.getElementById('prevBtn').disabled = index === 0;
        document.getElementById('nextBtn').disabled = index === this.playlist.length - 1;
        
        // Play the preview using <source> with explicit type, then load() then play()
        const url = song.previewUrl;
        if (url) {
          try {
            this.audio.pause();
            this.audioSource.src = url;       // set <source>
            this.audio.load();                // make browser pick up new source
            await this.audio.play();          // then play
            this.isPlaying = true;
            document.getElementById('playPauseBtn').textContent = '⏸';
          } catch (error) {
            console.error('Playback failed:', error);
            alert(`Failed to play "${song.title}". ${error?.message || 'No supported source was found.'}`);
            // Try next song
            setTimeout(() => this.playNext(), 500);
          }
        } else {
          alert(`No preview available for "${song.title}". Skipping to next song...`);
          setTimeout(() => this.playNext(), 500);
        }
      }

      clearNowPlaying() {
        this.songCards.forEach(card => card.classList.remove('now-playing'));
      }

      togglePlayPause() {
        if (this.isPlaying) {
          this.audio.pause();
          this.isPlaying = false;
          document.getElementById('playPauseBtn').textContent = '▶';
        } else {
          this.audio.play()
            .then(() => {
              this.isPlaying = true;
              document.getElementById('playPauseBtn').textContent = '⏸';
            })
            .catch(error => {
              console.error('Play failed:', error);
            });
        }
      }

      playNext() {
        this.playSong(this.currentIndex + 1);
      }

      playPrevious() {
        if (this.currentIndex > 0) {
          this.playSong(this.currentIndex - 1);
        }
      }

      handleAudioError(e) {
        console.error('Audio error:', e);
        const song = this.playlist[this.currentIndex];
        console.error(`Failed to play: ${song?.title} - ${song?.previewUrl}`);
        // Try next song after error
        setTimeout(() => this.playNext(), 500);
      }

      updateProgress() {
        const current = this.audio.currentTime;
        const duration = this.audio.duration;
        
        if (!isNaN(duration)) {
          const percentage = (current / duration) * 100;
          document.getElementById('progressFill').style.width = percentage + '%';
          document.getElementById('currentTime').textContent = this.formatTime(current);
          document.getElementById('totalTime').textContent = this.formatTime(duration);
        }
      }

      formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }
    }

    // ========== VOTING SYSTEM ==========
    class VotingSystem {
      constructor() {
        this.attachVoteListeners();
      }

      attachVoteListeners() {
        document.querySelectorAll('.upvote-btn, .downvote-btn').forEach(btn => {
          btn.addEventListener('click', (e) => this.handleVote(e));
        });
      }

      async handleVote(e) {
        const button = e.target;
        const url = button.dataset.url;
        const card = button.closest('.song-card');
        const scoreEl = card.querySelector('.vote-score');
        
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
              'Accept': 'application/json'
            }
          });
          
          const data = await response.json();
          
          // Update score
          scoreEl.textContent = data.vote_score;
          card.dataset.voteScore = data.vote_score;
          
          // Reorder queue with animation
          this.reorderQueue();
          
        } catch (error) {
          console.error('Vote failed:', error);
        }
      }

      reorderQueue() {
        const queueList = document.getElementById('queueList');
        const cards = Array.from(queueList.querySelectorAll('.song-card'));
        
        // Sort by vote score (descending)
        cards.sort((a, b) => {
          return parseInt(b.dataset.voteScore) - parseInt(a.dataset.voteScore);
        });
        
        // Reorder with animation
        cards.forEach((card, index) => {
          const currentIndex = Array.from(queueList.children).indexOf(card);
          if (currentIndex > index) {
            card.classList.add('moving-up');
            setTimeout(() => card.classList.remove('moving-up'), 500);
          }
          queueList.appendChild(card);
        });
      }
    }

    // ========== INITIALIZE ==========
    document.addEventListener('DOMContentLoaded', () => {
      const player = new QueuePlayer();
      const voting = new VotingSystem();
      
      // Auto-refresh queue every 30 seconds for real-time updates
      setInterval(() => {
        console.log('Queue refresh interval...');
      }, 30000);
    });
  </script>
</body>
</html>
